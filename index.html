<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Comfort Window Advisor</title>
  <link rel="manifest" href="manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('service-worker.js').catch(console.error);
      });
    }
  </script>
  <style>
    body { font-family: sans-serif; max-width: 500px; margin: auto; padding: 2rem; }
    label { display: block; margin-top: 1rem; }
    input, select { width: 100%; padding: 0.5rem; margin-top: 0.25rem; }
    button { margin-top: 1.5rem; padding: 0.75rem; width: 100%; }
    #result { margin-top: 2rem; font-size: 1.2rem; font-weight: bold; }
    #explanation { margin-top: 0.5rem; font-size: 1rem; font-weight: normal; color: #555; }
    #tipPoint { margin-top: 1rem; font-size: 0.95rem; font-style: italic; color: #444; }
  </style>
</head>
<body>
  <h1>Comfort Window Advisor</h1>
  <form id="comfortForm">
    <label>
      Zip Code (for outdoor weather):
      <input type="text" id="zipCode" maxlength="5" required />
    </label>
    <label>
      Is it daytime or nighttime?
      <select id="daytime" required>
        <option value="day">Daytime</option>
        <option value="night">Nighttime</option>
      </select>
    </label>
    <label>
      Indoor Temperature (°F):
      <input type="number" id="indoorTemp" required />
    </label>
    <label>
      Indoor Humidity (%):
      <input type="number" id="indoorHumidity" required />
    </label>
    <label>
      Outdoor Temperature (°F):
      <input type="number" id="outdoorTemp" />
    </label>
    <label>
      Outdoor Humidity (%):
      <input type="number" id="outdoorHumidity" />
    </label>
    <button type="submit">Should I open the windows?</button>
  </form>
  <div id="result"></div>
  <div id="explanation"></div>
  <div id="tipPoint"></div>

  <script>
    async function getWeather(zip) {
      try {
        const response = await fetch(`https://api.weatherapi.com/v1/current.json?key=demo&q=${zip}&aqi=no`);
        const data = await response.json();
        return {
          temp_f: data.current.temp_f,
          humidity: data.current.humidity
        };
      } catch (error) {
        return null;
      }
    }

    function calculateHeatIndex(T, RH) {
      const c1 = -42.379, c2 = 2.04901523, c3 = 10.14333127;
      const c4 = -0.22475541, c5 = -0.00683783, c6 = -0.05481717;
      const c7 = 0.00122874, c8 = 0.00085282, c9 = -0.00000199;

      const HI = c1 + c2 * T + c3 * RH + c4 * T * RH + c5 * T * T +
                c6 * RH * RH + c7 * T * T * RH + c8 * T * RH * RH +
                c9 * T * T * RH * RH;

      return (T >= 80 && RH >= 40) ? HI : T;
    }

    function findTippingPoint(indoorHI, isDaytime) {
      let humidity = 50;
      let tempLow = 30, tempHigh = 110, threshold = 0.5, midTemp, testHI;

      while (tempHigh - tempLow > 0.5) {
        midTemp = (tempLow + tempHigh) / 2;
        testHI = calculateHeatIndex(midTemp, humidity);
        if (isDaytime) testHI += 2;
        if (testHI < indoorHI) {
          tempLow = midTemp;
        } else {
          tempHigh = midTemp;
        }
      }
      return {
        temp: Math.round(midTemp * 10) / 10,
        humidity: humidity
      };
    }

    document.getElementById("zipCode").addEventListener("blur", async function() {
      const zip = this.value;
      const tempInput = document.getElementById("outdoorTemp");
      const humidityInput = document.getElementById("outdoorHumidity");
      if (zip.length === 5) {
        const weather = await getWeather(zip);
        if (weather) {
          tempInput.value = weather.temp_f;
          humidityInput.value = weather.humidity;
          tempInput.readOnly = true;
          humidityInput.readOnly = true;
        } else {
          tempInput.readOnly = false;
          humidityInput.readOnly = false;
          alert("Could not fetch weather data. You can enter outdoor temperature and humidity manually.");
        }
      }
    });

    document.getElementById("comfortForm").addEventListener("submit", function(e) {
      e.preventDefault();

      const indoorTemp = parseFloat(document.getElementById("indoorTemp").value);
      const indoorHumidity = parseFloat(document.getElementById("indoorHumidity").value);
      const outdoorTemp = parseFloat(document.getElementById("outdoorTemp").value);
      const outdoorHumidity = parseFloat(document.getElementById("outdoorHumidity").value);
      const isDaytime = document.getElementById("daytime").value === "day";

      const indoorHI = calculateHeatIndex(indoorTemp, indoorHumidity);
      let outdoorHI = calculateHeatIndex(outdoorTemp, outdoorHumidity);
      if (isDaytime) outdoorHI += 2;

      const result = document.getElementById("result");
      const explanation = document.getElementById("explanation");
      const tipPoint = document.getElementById("tipPoint");

      const diff = outdoorHI - indoorHI;
      if (diff < -2) {
        result.textContent = "Yes, open the windows—it'll feel better!";
        explanation.textContent = "The air outside feels cooler and less muggy than inside. Opening the windows should make your space feel more comfortable.";
      } else if (diff > 2) {
        result.textContent = "No, keep them closed—outside would be worse.";
        explanation.textContent = "The air outside feels hotter or stickier than what you have indoors. Opening the windows might make it feel worse.";
      } else {
        result.textContent = "Meh, doesn’t matter much. Conditions are pretty similar.";
        explanation.textContent = "There's not a big difference between inside and outside. You probably won't feel much change either way.";
      }

      const tip = findTippingPoint(indoorHI, isDaytime);
      tipPoint.textContent = `If the outdoor temperature were around ${tip.temp}°F with 50% humidity, it'd feel about the same as inside.`;
    });
  </script>
</body>
</html>