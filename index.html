<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Window Wise</title>
  <link rel="manifest" href="manifest.json" />
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js').catch(console.error);
      });
    }
  </script>
  <style>
    body { font-family: sans-serif; max-width: 500px; margin: auto; padding: 2rem; }
    label { display: block; margin-top: 1rem; }
    input, select { width: 100%; padding: 0.5rem; margin-top: 0.25rem; }
    button { margin-top: 1.5rem; padding: 0.75rem; width: 100%; }
    #result, #comfortScores { margin-top: 2rem; font-size: 1.2rem; font-weight: bold; }
    #explanation, #tipPoint, #smartTip { margin-top: 0.5rem; font-size: 1rem; color: #555; }
  </style>
</head>
<body>
  <h1>Window Wise</h1>
  <form id="comfortForm">
    <label>
      Use my location?
      <input type="checkbox" id="useLocation" />
    </label>
    <label>
      Zip Code:
      <input type="text" id="zipCode" maxlength="5" required />
      <button type="button" id="lookupZip">Fetch Weather</button>
    </label>
    <label>
      Is it daytime or nighttime?
      <select id="daytime" required>
        <option value="day">Daytime</option>
        <option value="night">Nighttime</option>
      </select>
    </label>
    <label>
      Indoor Temperature (°F):
      <input type="number" id="indoorTemp" required />
    </label>
    <label>
      Indoor Humidity (%):
      <input type="number" id="indoorHumidity" required />
    </label>
    <label>
      Outdoor Temperature (°F):
      <input type="number" id="outdoorTemp" />
    </label>
    <label>
      Outdoor Humidity (%):
      <input type="number" id="outdoorHumidity" />
    </label>
    <button type="submit">Should I open the windows?</button>
  </form>

  <div id="comfortScores"></div>
  <div id="result"></div>
  <div id="explanation"></div>
  <button id="showExplain" type="button">Wanna know more?</button><div id="explainMore" style="display:none; font-size: 0.95rem; margin-top: 0.75rem; color: #444;"></div>
  <div id="smartTip"></div>

  <script>
    const weatherKey = "demo"; // Replace with your real API key

    async function fetchWeather(zip) {
      try {
        const res = await fetch(`https://api.weatherapi.com/v1/current.json?key=${weatherKey}&q=${zip}`);
        const data = await res.json();
        return data.current;
      } catch (err) {
        alert("Weather lookup failed.");
        return null;
      }
    }

        function heatIndex(T, RH) {
      const c1 = -42.379, c2 = 2.04901523, c3 = 10.14333127, c4 = -0.22475541,
            c5 = -0.00683783, c6 = -0.05481717, c7 = 0.00122874,
            c8 = 0.00085282, c9 = -0.00000199;
      const HI = c1 + c2*T + c3*RH + c4*T*RH + c5*T*T + c6*RH*RH +
                 c7*T*T*RH + c8*T*RH*RH + c9*T*T*RH*RH;
      return (T >= 80 && RH >= 40) ? HI : T;
    }

    function scoreComfort(HI) {
      if (HI < 65) return {score: 9, emoji: '😌 Cool'};
      if (HI < 75) return {score: 8, emoji: '🙂 Pleasant'};
      if (HI < 82) return {score: 6, emoji: '😐 Mild'};
      if (HI < 90) return {score: 4, emoji: '🥵 Warm'};
      return {score: 2, emoji: '🔥 Hot'};
    }

    function findTippingPoint(indoorHI, isDaytime) {
      let humidity = 50, low = 30, high = 110, mid;
      while (high - low > 0.5) {
        mid = (low + high) / 2;
        let hi = heatIndex(mid, humidity);
        if (isDaytime) hi += 2;
        (hi < indoorHI) ? low = mid : high = mid;
      }
      return Math.round(mid * 10) / 10;
    }

    function giveSmartTip(temp, isDay) {
      if (!isDay && temp < 70) return "Open them up while it's cool tonight.";
      if (isDay && temp > 85) return "Try early mornings or late evenings instead.";
      return "This might be the best time of day for fresh air.";
    }

    document.getElementById("useLocation").addEventListener("change", async function () {
      if (!this.checked) return;
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const weather = await fetchWeather(`${pos.coords.latitude},${pos.coords.longitude}`);
          if (weather) {
            document.getElementById("outdoorTemp").value = Math.round(weather.temp_f);
            document.getElementById("outdoorHumidity").value = Math.round(weather.humidity);
          }
        }
      });
    });

    document.getElementById("lookupZip").addEventListener("click", async () => {
      const zip = document.getElementById("zipCode").value;
      if (zip.length === 5) {
        const weather = await fetchWeather(zip);
        if (weather) {
          document.getElementById("outdoorTemp").value = Math.round(weather.temp_f);
          document.getElementById("outdoorHumidity").value = Math.round(weather.humidity);
        }
      } else {
        alert("Please enter a valid 5-digit ZIP code.");
      }
    });

    document.getElementById("comfortForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const inT = parseFloat(document.getElementById("indoorTemp").value);
      const inH = parseFloat(document.getElementById("indoorHumidity").value);
      const outT = parseFloat(document.getElementById("outdoorTemp").value);
      const outH = parseFloat(document.getElementById("outdoorHumidity").value);
      const isDay = document.getElementById("daytime").value === "day";

      const inHI = heatIndex(inT, inH);
      let outHI = heatIndex(outT, outH);
      if (isDay) outHI += 2;

      const inScore = scoreComfort(inHI);
      const outScore = scoreComfort(outHI);
      document.getElementById("comfortScores").textContent =
        `Indoor: ${inScore.emoji} (${inScore.score}/10) — Outdoor: ${outScore.emoji} (${outScore.score}/10)`;

      const result = document.getElementById("result");
      const diff = Math.round((outHI - inHI) * 10) / 10;
      result.textContent = diff < -2 ? "Yes, open the windows—it'll feel better!" :
                            diff > 2 ? "No, keep them closed—outside would be worse." :
                            "Meh, doesn’t matter much. Conditions are similar.";

      document.getElementById("explanation").textContent = "Based on heat index and humidity comfort levels.";
      
      document.getElementById("smartTip").textContent = giveSmartTip(outT, isDay);
      document.getElementById("showExplain").onclick = () => {
        document.getElementById("explainMore").style.display = "block";
        document.getElementById("explainMore").textContent = 
          "We compare how hot and humid it feels inside versus outside using the heat index. If it feels much better outside, we suggest opening the windows. If they’re close, we say it won’t matter much.";
      };
    });
  </script>
</body>
</html>
